#!/usr/bin/env bash
set -euo pipefail

repo_root="$(git rev-parse --show-toplevel)"
cd "$repo_root"

if ! command -v uv >/dev/null 2>&1; then
  echo "pre-commit: uv is required to run checks" >&2
  exit 1
fi

if ! command -v rg >/dev/null 2>&1; then
  echo "pre-commit: rg is required for privacy scans" >&2
  exit 1
fi

scan_path="tests/fixtures"
privacy_fail=0

if [ -d "$scan_path" ]; then
  if rg -n "[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\\.[A-Za-z]{2,}" "$scan_path"; then
    echo "pre-commit: privacy scan failed (emails)" >&2
    privacy_fail=1
  fi

  url_matches="$(rg -n "https?://" "$scan_path" || true)"
  if [ -n "$url_matches" ]; then
    if echo "$url_matches" | rg -n -v "https?://HOST-"; then
      echo "pre-commit: privacy scan failed (urls)" >&2
      privacy_fail=1
    fi
  fi

  if rg -n "\\b(?:\\d{1,3}\\.){3}\\d{1,3}\\b" "$scan_path"; then
    echo "pre-commit: privacy scan failed (ipv4)" >&2
    privacy_fail=1
  fi

  ipv6_matches="$(rg -n "\\b(?:[0-9A-Fa-f]{1,4}:){2,}[0-9A-Fa-f]{1,4}\\b" "$scan_path" || true)"
  if [ -n "$ipv6_matches" ]; then
    # Exclude standard timestamps (YYYY-MM-DD HH:MM:SS) from IPv6 detection
    if echo "$ipv6_matches" | rg -v "\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2}" >/dev/null; then
      echo "$ipv6_matches" | rg -v "\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2}"
      echo "pre-commit: privacy scan failed (ipv6)" >&2
      privacy_fail=1
    fi
  fi

  if rg -n "\\b(sk-[A-Za-z0-9]{10,}|sk_live_[A-Za-z0-9]{10,}|gh[opurs]_[A-Za-z0-9]{30,}|xox[baprs]-[A-Za-z0-9-]{10,}|A(?:KIA|SIA)[0-9A-Z]{16}|AIza[0-9A-Za-z_-]{35}|ya29\\.[0-9A-Za-z_-]+)\\b" "$scan_path"; then
    echo "pre-commit: privacy scan failed (tokens)" >&2
    privacy_fail=1
  fi
fi

if [ "$privacy_fail" -ne 0 ]; then
  exit 1
fi

uv lock --check
uv run python -m pytest -q
